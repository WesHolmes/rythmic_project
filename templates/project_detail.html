{% extends "base.html" %}

{% block title %}{{ project.name }} - Rhythmic{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8" data-project-id="{{ project.id }}" data-user-id="{{ current_user.id }}">
    <div class="mb-8">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
            <div>
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                    {{ project.name }}
                </h1>
                {% if project.description %}
                <p class="text-gray-400 text-lg">{{ project.description }}</p>
                {% endif %}
            </div>
            <div class="flex flex-col sm:flex-row gap-3">
                {% if user_permissions.can_create_tasks %}
                <a href="{{ url_for('new_task', project_id=project.id) }}"
                    class="btn-primary text-white px-6 py-3 rounded-xl font-semibold inline-flex items-center shadow-lg">
                    <i class="fas fa-plus mr-2"></i>Add Task
                </a>
                {% endif %}
                {% if user_permissions.can_edit_project %}
                <a href="{{ url_for('edit_project', id=project.id) }}"
                    class="glass text-white px-6 py-3 rounded-xl font-semibold inline-flex items-center hover:bg-white/10 transition-all duration-200">
                    <i class="fas fa-edit mr-2"></i>Edit Project
                </a>
                {% endif %}
                {% if user_permissions.can_manage_collaborators %}
                <button id="manage-sharing-btn"
                    class="glass text-white px-6 py-3 rounded-xl font-semibold inline-flex items-center hover:bg-white/10 transition-all duration-200">
                    <i class="fas fa-share-alt mr-2"></i>Share Project
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Real-time Status and Active Users -->
    <div class="mb-6">
        <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-blue-400 text-sm font-medium">
                        <i class="fas fa-user-tag mr-1"></i>
                        Your role: <span class="text-white">{{ user_role|title }}</span>
                    </div>
                    <div class="text-gray-400 text-sm">
                        <i class="fas fa-users mr-1"></i>
                        <span id="active-user-count">1</span> active
                    </div>
                    <div id="connection-status" class="text-green-400 text-sm">
                        <i class="fas fa-circle mr-1"></i>
                        Online
                    </div>
                </div>
                <div id="active-users" class="flex items-center space-x-2">
                    <!-- Active users will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Card removed - functionality migrated to Quick Actions in Control Panel -->


    <!-- Filter Section -->
    <div class="glass rounded-2xl p-4 mb-6">
        <div class="flex flex-col gap-4">
            <!-- Filter Controls -->
            <div class="flex flex-nowrap gap-2 items-center overflow-x-auto">
                <!-- Workflow Filter Buttons and Search -->
                <button id="workflow-all" class="workflow-filter-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-all duration-200 border border-gray-600 active flex-shrink-0">
                    <i class="fas fa-list mr-2"></i>All Tasks
                </button>
                <button id="workflow-backlog" class="workflow-filter-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-all duration-200 border border-gray-600 flex-shrink-0" data-workflow="backlog">
                    <i class="fas fa-clock mr-2"></i>Unstarted
                </button>
                <button id="workflow-in_progress" class="workflow-filter-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-all duration-200 border border-gray-600 flex-shrink-0" data-workflow="in_progress">
                    <i class="fas fa-play mr-2"></i>Started
                </button>
                <button id="workflow-committed" class="workflow-filter-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-all duration-200 border border-gray-600 flex-shrink-0" data-workflow="committed">
                    <i class="fas fa-check-circle mr-2"></i>Committed
                </button>
                <button id="workflow-completed" class="workflow-filter-btn px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium rounded-lg transition-all duration-200 border border-gray-600 flex-shrink-0" data-workflow="completed">
                    <i class="fas fa-flag-checkered mr-2"></i>Completed
                </button>
                
                <!-- Search Bar -->
                <div class="relative flex-shrink-0">
                    <input type="text" id="search-tasks" placeholder="Search tasks..."
                        class="pl-10 pr-3 py-2 bg-gray-800 border border-gray-600 rounded-lg text-white placeholder-gray-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-48">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Subtle Filter Toggle Button -->
    <button id="advanced-filters-toggle" class="fixed left-4 top-1/2 transform -translate-y-1/2 z-40 bg-gray-800/80 hover:bg-gray-700/90 border border-gray-600/50 hover:border-gray-500/70 rounded-full p-3 text-gray-300 hover:text-white transition-all duration-300 ease-in-out backdrop-blur-sm shadow-lg hover:shadow-xl">
        <i class="fas fa-bars text-lg"></i>
    </button>

    <!-- Control Panel Side Panel -->
    <div id="advanced-filters-panel" class="fixed left-0 top-0 h-full w-56 bg-gray-900 border-r border-gray-700 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 overflow-y-auto">
        <div class="p-2">
            <!-- Panel Header -->
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-semibold text-white flex items-center">
                    <i class="fas fa-cog mr-1.5 text-blue-400"></i>Control Panel
                </h3>
                <button id="close-filters-panel" class="text-gray-400 hover:text-white transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Risk Overview Section -->
            <div class="mb-3">
                <div class="bg-gray-800/50 rounded p-2 border border-gray-700">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-xs font-semibold text-white flex items-center">
                            <i class="fas fa-shield-alt mr-1.5 text-red-400"></i>
                            Risk Overview
                        </h4>
                        <button onclick="showDetailedRiskDashboard()"
                            class="text-xs text-gray-400 hover:text-white transition-colors">
                            Details <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-1">
                        <div class="risk-item-card">
                            <div class="p-1.5 text-center">
                                <div class="text-sm font-bold text-green-400" id="risk-low-count">0</div>
                                <div class="text-xs text-gray-300">Low</div>
                            </div>
                        </div>
                        <div class="risk-item-card">
                            <div class="p-1.5 text-center">
                                <div class="text-sm font-bold text-yellow-400" id="risk-medium-count">0</div>
                                <div class="text-xs text-gray-300">Med</div>
                            </div>
                        </div>
                        <div class="risk-item-card">
                            <div class="p-1.5 text-center">
                                <div class="text-sm font-bold text-orange-400" id="risk-high-count">0</div>
                                <div class="text-xs text-gray-300">High</div>
                            </div>
                        </div>
                        <div class="risk-item-card">
                            <div class="p-1.5 text-center">
                                <div class="text-sm font-bold text-red-400" id="risk-critical-count">0</div>
                                <div class="text-xs text-gray-300">Crit</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Filter Controls -->
            <div class="mb-3">
                <h4 class="text-xs font-semibold text-white mb-2 flex items-center">
                    <i class="fas fa-filter mr-1.5 text-yellow-400"></i>
                    Filters
                </h4>
                <div class="space-y-2">
                    <!-- Priority Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Priority</label>
                        <select id="priority-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Priorities</option>
                            <option value="low" class="bg-gray-700 text-white">Low</option>
                            <option value="medium" class="bg-gray-700 text-white">Medium</option>
                            <option value="high" class="bg-gray-700 text-white">High</option>
                        </select>
                    </div>

                    <!-- Label Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Label</label>
                        <select id="label-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Labels</option>
                            {% for label in labels %}
                            <option value="{{ label.id }}" class="bg-gray-700 text-white">{{ label.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Risk Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Risk Level</label>
                        <select id="risk-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Risks</option>
                            <option value="low" class="bg-gray-700 text-white">Low Risk</option>
                            <option value="medium" class="bg-gray-700 text-white">Medium Risk</option>
                            <option value="high" class="bg-gray-700 text-white">High Risk</option>
                            <option value="critical" class="bg-gray-700 text-white">Critical Risk</option>
                        </select>
                    </div>

                    <!-- Assignment Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Assignment</label>
                        <select id="assignment-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Tasks</option>
                            <option value="assigned" class="bg-gray-700 text-white">My Tasks</option>
                        </select>
                    </div>


                    <!-- Due Date Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Due Date</label>
                        <select id="due-date-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Dates</option>
                            <option value="overdue" class="bg-gray-700 text-white">Overdue</option>
                            <option value="today" class="bg-gray-700 text-white">Due Today</option>
                            <option value="week" class="bg-gray-700 text-white">This Week</option>
                            <option value="month" class="bg-gray-700 text-white">This Month</option>
                            <option value="no_date" class="bg-gray-700 text-white">No Due Date</option>
                        </select>
                    </div>

                    <!-- Created Date Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-300 mb-1">Created</label>
                        <select id="created-date-filter"
                            class="w-full px-1.5 py-1 bg-gray-700 border border-gray-600 rounded text-white text-xs focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent">
                            <option value="" class="bg-gray-700 text-white">All Time</option>
                            <option value="today" class="bg-gray-700 text-white">Today</option>
                            <option value="week" class="bg-gray-700 text-white">This Week</option>
                            <option value="month" class="bg-gray-700 text-white">This Month</option>
                            <option value="year" class="bg-gray-700 text-white">This Year</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mb-3">
                <h4 class="text-xs font-semibold text-white mb-2 flex items-center">
                    <i class="fas fa-bolt mr-1.5 text-purple-400"></i>
                    Quick Actions
                </h4>
                <div class="space-y-1">
                    <button id="calendar-view-btn" class="w-full px-1.5 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-calendar-alt mr-1"></i>Calendar View
                    </button>
                    <button id="ai-summary-btn" class="w-full px-1.5 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-robot mr-1"></i>AI Summary
                    </button>
                    {% if user_permissions.can_manage_collaborators %}
                    <button id="manage-collaborators-btn" class="w-full px-1.5 py-1 bg-green-600 hover:bg-green-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-users mr-1"></i>Manage Collaborators
                    </button>
                    {% endif %}
                    {% if user_permissions.can_edit_project %}
                    <button id="manage-labels-btn" class="w-full px-1.5 py-1 bg-pink-600 hover:bg-pink-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-tags mr-1"></i>Manage Labels
                    </button>
                    {% endif %}
                    <a href="{{ url_for('export_project', id=project.id) }}" class="w-full px-1.5 py-1 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-download mr-1"></i>Export Project
                    </a>
                    {% if user_permissions.can_create_tasks %}
                    <a href="{{ url_for('import_project', id=project.id) }}" class="w-full px-1.5 py-1 bg-teal-600 hover:bg-teal-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-upload mr-1"></i>Import Project
                    </a>
                    {% endif %}
                    {% if not tasks and user_permissions.can_create_tasks %}
                    <button id="generate-tasks-btn" class="w-full px-1.5 py-1 bg-yellow-600 hover:bg-yellow-700 text-white text-xs font-medium rounded transition-all duration-200 flex items-center justify-center">
                        <i class="fas fa-robot mr-1"></i>Generate Starter Tasks
                    </button>
                    {% endif %}
                </div>
            </div>

            <!-- Clear Filters Button -->
            <div class="pt-2 border-t border-gray-600">
                <button id="clear-all-filters" class="w-full px-1.5 py-1 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded transition-all duration-200">
                    <i class="fas fa-times mr-1"></i>Clear All
                </button>
            </div>
        </div>
    </div>


    <!-- Tasks List -->
    <div id="tasks-list" class="glass rounded-2xl overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold text-white">Tasks (<span id="task-count">{{ tasks|length }}</span>)
                </h2>
                <div class="flex items-center space-x-2">
                    <div class="flex items-center bg-gray-800/50 rounded-lg p-1">
                        <button id="toggle-drag-drop-btn"
                            class="text-xs px-3 py-1.5 rounded-md text-gray-300 hover:text-white hover:bg-gray-700 transition-all duration-200">
                            <i class="fas fa-arrows-alt mr-1"></i>Reorder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        {% if tasks %}
        <div id="tasks-container" class="divide-y divide-gray-700">
            {% for task in tasks %}
            <div class="task-item px-6 py-4 hover:bg-gray-800/30 transition-colors duration-200"
                data-task-id="{{ task.id }}" data-parent-id="{{ task.parent_id or '' }}"
                data-sort-order="{{ task.sort_order }}" data-risk-level="{{ task.risk_level }}"
                data-is-expanded="{{ task.is_expanded|lower }}"
                style="{% if task.parent_id %}margin-left: calc(20px * var(--nesting-level, 1)); border-left: 2px solid #374151;{% endif %}"
                data-nesting-level="0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <!-- Drag Handle -->
                        <div class="drag-handle cursor-move text-gray-500 hover:text-gray-300" style="display: none;">
                            <i class="fas fa-grip-vertical"></i>
                        </div>

                        <!-- Hierarchy Controls -->
                        {% if task.children %}
                        <button class="expand-toggle text-gray-500 hover:text-gray-300" data-task-id="{{ task.id }}" title="{{ task.children|length }} child task{{ 's' if task.children|length != 1 else '' }}">
                            <i class="fas fa-chevron-right transition-transform duration-200"></i>
                            <span class="ml-1 text-xs text-gray-400">({{ task.children|length }})</span>
                        </button>
                        {% else %}
                        <div class="w-4"></div>
                        {% endif %}

                        <div class="flex-shrink-0">
                            {% if task.status == 'completed' %}
                            <i class="fas fa-check-circle text-green-400 text-xl"></i>
                            {% elif task.status == 'in_progress' %}
                            <i class="fas fa-play-circle text-blue-400 text-xl"></i>
                            {% elif task.status == 'blocked' %}
                            <i class="fas fa-exclamation-circle text-red-400 text-xl"></i>
                            {% else %}
                            <i class="fas fa-circle text-gray-500 text-xl"></i>
                            {% endif %}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-lg font-medium text-white">
                                    <a href="{{ url_for('edit_task', project_id=project.id, task_id=task.id) }}"
                                        class="hover:text-blue-400 transition-colors duration-200">
                                        {{ task.title }}
                                    </a>
                                </h3>
                                <!-- Due Date for Filtering -->
                                {% if task.end_date %}
                                <span class="due-date hidden">{{ task.end_date.strftime('%Y-%m-%d') }}</span>
                                {% endif %}
                                <!-- Created Date for Filtering -->
                                <span class="created-date hidden">{{ task.created_at.strftime('%Y-%m-%d') }}</span>
                                <!-- Risk Indicator -->
                                {% if task.risk_level and task.risk_level != 'low' %}
                                <span
                                    class="risk-indicator inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                        {% if task.risk_level == 'critical' %}bg-red-500/20 text-red-400
                                        {% elif task.risk_level == 'high' %}bg-orange-500/20 text-orange-400
                                        {% elif task.risk_level == 'medium' %}bg-yellow-500/20 text-yellow-400{% endif %}">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    {{ task.risk_level.title() }} Risk
                                </span>
                                {% endif %}
                                
                                <!-- Flag Indicator -->
                                {% if task.is_flagged %}
                                <span class="flag-indicator inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                    {% if task.flag_resolved %}bg-green-500/20 text-green-400{% else %}bg-red-500/20 text-red-400{% endif %}">
                                    <i class="fas fa-flag mr-1"></i>
                                    {% if task.flag_resolved %}Flag Resolved{% else %}Flagged{% endif %}
                                </span>
                                {% endif %}
                            </div>

                            {% if task.description %}
                            <p class="text-gray-400 mt-1">{{ task.description[:100] }}{% if task.description|length >
                                100 %}...{% endif %}</p>
                            {% endif %}

                            <div class="flex items-center space-x-4 mt-3 text-sm">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                                        {% if task.priority == 'high' %}bg-red-500/20 text-red-400
                                        {% elif task.priority == 'medium' %}bg-yellow-500/20 text-yellow-400
                                        {% else %}bg-green-500/20 text-green-400{% endif %}">
                                    {{ task.priority.title() }}
                                </span>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                                        {% if task.size == 'large' %}bg-purple-500/20 text-purple-400
                                        {% elif task.size == 'medium' %}bg-blue-500/20 text-blue-400
                                        {% else %}bg-gray-500/20 text-gray-400{% endif %}">
                                    {{ task.size.title() }}
                                </span>
                                <span class="text-gray-500">{{ task.owner.name }}</span>
                                {% if task.assigned_user %}
                                <div class="inline-flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
                                        <i class="fas fa-user mr-1"></i>
                                        Assigned to: {{ task.assigned_user.name }}
                                    </span>
                                    {% if user_permissions.can_assign_tasks %}
                                    <button class="unassign-task text-gray-500 hover:text-red-400 p-1 rounded-md hover:bg-red-500/10 transition-all duration-200"
                                        data-task-id="{{ task.id }}" 
                                        title="Unassign Task">
                                        <i class="fas fa-user-times text-xs"></i>
                                    </button>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% if task.start_date %}
                                <span class="text-gray-500">{{ task.start_date.strftime('%b %d') }}</span>
                                {% endif %}
                                {% if task.end_date %}
                                <span class="text-gray-500">â†’ {{ task.end_date.strftime('%b %d') }}</span>
                                {% endif %}
                            </div>

                            <!-- Dependencies -->
                            {% if task.dependencies %}
                            <div class="flex items-center space-x-2 mt-2">
                                <span class="text-xs text-gray-500">Depends on:</span>
                                {% for dep in task.dependencies %}
                                <span
                                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
                                    <i class="fas fa-link mr-1"></i>
                                    {{ dep.depends_on_title }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Task Labels -->
                        {% if task.labels %}
                        <div class="flex flex-wrap gap-1 max-w-32">
                            {% for label in task.labels %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                style="background-color: {{ label.color }}20; color: {{ label.color }}">
                                <i class="{{ label.icon }} mr-1 text-xs"></i>
                                {{ label.name }}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="flex items-center space-x-1">
                            <!-- Workflow Button -->
                            {% if user_permissions.can_edit_tasks %}
                            {% set task_data = tasks_data|selectattr('id', 'equalto', task.id)|first %}
                            <button
                                class="workflow-btn px-3 py-1.5 text-xs font-medium text-white rounded-md transition-all duration-200 {{ task_data.workflow_button_class if task_data else 'bg-blue-600 hover:bg-blue-700' }}"
                                data-task-id="{{ task.id }}" 
                                data-workflow-status="{{ task_data.workflow_status if task_data else 'backlog' }}"
                                title="Workflow: {{ task_data.workflow_button_text if task_data else 'Start' }}">
                                <i class="fas fa-play mr-1"></i>{{ task_data.workflow_button_text if task_data else 'Start' }}
                            </button>
                            
                            <!-- Reset Workflow Button (only for completed tasks) -->
                            {% if task_data and task_data.can_reset_workflow %}
                            <button
                                class="reset-workflow-btn px-3 py-1.5 text-xs font-medium text-white rounded-md transition-all duration-200 {{ task_data.reset_button_class if task_data else 'bg-red-600 hover:bg-red-700' }} opacity-90 hover:opacity-100"
                                data-task-id="{{ task.id }}" 
                                data-workflow-status="{{ task_data.workflow_status if task_data else 'completed' }}"
                                title="Reset Workflow: Move back to backlog status">
                                <i class="fas fa-undo mr-1"></i>{{ task_data.reset_button_text if task_data else 'Reset' }}
                            </button>
                            {% endif %}
                            
                            <!-- Create Child Task Button -->
                            {% if user_permissions.can_create_tasks %}
                            <button
                                class="create-child-task-btn px-3 py-1.5 text-xs font-medium text-white rounded-md transition-all duration-200 bg-purple-600 hover:bg-purple-700"
                                data-task-id="{{ task.id }}" 
                                data-task-title="{{ task.title }}"
                                title="Create Child Tasks">
                                <i class="fas fa-plus mr-1"></i>Add Child
                            </button>
                            {% endif %}
                            {% endif %}
                            
                            <!-- Task Details Dropdown Toggle -->
                            <button
                                class="task-details-toggle text-gray-500 hover:text-blue-400 p-1.5 rounded-md hover:bg-blue-500/10 transition-all duration-200"
                                data-task-id="{{ task.id }}" title="View Task Details">
                                <i class="fas fa-chevron-down text-sm transition-transform duration-200"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Task Details Dropdown Content -->
                <div class="task-details-content hidden bg-gray-800/30 border-t border-gray-700 px-6 py-4">
                    <!-- Task Actions Section -->
                    <div class="mb-6 pb-4 border-b border-gray-700">
                        <h4 class="text-sm font-semibold text-gray-300 mb-3 flex items-center">
                            <i class="fas fa-cogs mr-2 text-blue-400"></i>
                            Task Actions
                        </h4>
                        <div class="flex flex-wrap gap-3">
                            <!-- Task Flag/Discussion Button (All users) -->
                            {% if user_permissions.can_flag_tasks %}
                            <button
                                class="task-flag-btn px-4 py-2 text-sm font-medium text-white rounded-lg transition-all duration-200 
                                {% if task.is_flagged %}
                                    {% if task.flag_resolved %}bg-green-600 hover:bg-green-700{% else %}bg-red-600 hover:bg-red-700{% endif %}
                                {% else %}bg-orange-600 hover:bg-orange-700{% endif %}"
                                data-task-id="{{ task.id }}" 
                                data-flag-status="{{ task.get_flag_status() }}"
                                title="{% if task.is_flagged %}{% if task.flag_resolved %}Flag resolved{% else %}Flagged for clarification{% endif %}{% elif task.discussion_comments %}View discussion{% else %}Flag for clarification{% endif %}">
                                <i class="fas fa-flag mr-2"></i>
                                {% if task.is_flagged %}
                                    {% if task.flag_resolved %}Flag Resolved{% else %}Flagged{% endif %}
                                {% elif task.discussion_comments %}View Discussion{% else %}Flag Task{% endif %}
                            </button>
                            {% endif %}
                            
                            {% if user_permissions.can_edit_tasks %}
                            <!-- Dependency Management -->
                            <button
                                class="manage-dependencies px-4 py-2 text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-all duration-200"
                                data-task-id="{{ task.id }}" title="Manage Dependencies">
                                <i class="fas fa-project-diagram mr-2"></i>
                                Manage Dependencies
                            </button>
                            {% endif %}
                            
                            {% if user_permissions.can_assign_tasks %}
                            <!-- Task Assignment -->
                            <button
                                class="assign-task px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition-all duration-200"
                                data-task-id="{{ task.id }}" 
                                data-assigned-to="{{ task.assigned_to or '' }}"
                                title="Assign Task">
                                <i class="fas fa-user-plus mr-2"></i>
                                Assign Task
                            </button>
                            {% endif %}
                            
                            {% if user_permissions.can_edit_tasks %}
                            <!-- Delete Task -->
                            <form method="POST"
                                action="{{ url_for('delete_task', project_id=project.id, task_id=task.id) }}"
                                class="inline" onsubmit="return confirm('Are you sure you want to delete this task?')">
                                <button type="submit"
                                    class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-lg transition-all duration-200"
                                    title="Delete Task">
                                    <i class="fas fa-trash mr-2"></i>
                                    Delete Task
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- Full Description -->
                            {% if task.description %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-align-left mr-2 text-blue-400"></i>
                                    Description
                                </h4>
                                <div class="text-gray-300 text-sm leading-relaxed whitespace-pre-wrap">{{ task.description }}</div>
                            </div>
                            {% endif %}
                            
                            <!-- Risk Information -->
                            {% if task.risk_level and task.risk_level != 'low' %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-exclamation-triangle mr-2 text-orange-400"></i>
                                    Risk Assessment
                                </h4>
                                <div class="space-y-2">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-400">Level:</span>
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                            {% if task.risk_level == 'critical' %}bg-red-500/20 text-red-400
                                            {% elif task.risk_level == 'high' %}bg-orange-500/20 text-orange-400
                                            {% elif task.risk_level == 'medium' %}bg-yellow-500/20 text-yellow-400{% endif %}">
                                            {{ task.risk_level.title() }}
                                        </span>
                                    </div>
                                    {% if task.risk_description %}
                                    <div>
                                        <span class="text-xs text-gray-400 block mb-1">Description:</span>
                                        <div class="text-gray-300 text-sm">{{ task.risk_description }}</div>
                                    </div>
                                    {% endif %}
                                    {% if task.mitigation_plan %}
                                    <div>
                                        <span class="text-xs text-gray-400 block mb-1">Mitigation Plan:</span>
                                        <div class="text-gray-300 text-sm">{{ task.mitigation_plan }}</div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Task Metadata -->
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-info-circle mr-2 text-green-400"></i>
                                    Task Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Status:</span>
                                        <span class="text-white">{{ task.status.replace('_', ' ').title() }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Priority:</span>
                                        <span class="text-white">{{ task.priority.title() }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Size:</span>
                                        <span class="text-white">{{ task.size.title() }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Owner:</span>
                                        <span class="text-white">{{ task.owner.name }}</span>
                                    </div>
                                    {% if task.start_date %}
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Start Date:</span>
                                        <span class="text-white">{{ task.start_date.strftime('%B %d, %Y') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if task.end_date %}
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">End Date:</span>
                                        <span class="text-white">{{ task.end_date.strftime('%B %d, %Y') }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Created:</span>
                                        <span class="text-white">{{ task.created_at.strftime('%B %d, %Y') }}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-400">Updated:</span>
                                        <span class="text-white">{{ task.updated_at.strftime('%B %d, %Y') }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dependencies -->
                            {% if task.dependencies or task.dependents %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-project-diagram mr-2 text-purple-400"></i>
                                    Dependencies
                                </h4>
                                <div class="space-y-2">
                                    {% if task.dependencies %}
                                    <div>
                                        <span class="text-xs text-gray-400 block mb-1">Depends on:</span>
                                        {% for dep in task.dependencies %}
                                        <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400 mr-1 mb-1">
                                            <i class="fas fa-link mr-1"></i>
                                            {{ dep.depends_on_title }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    {% if task.dependents %}
                                    <div>
                                        <span class="text-xs text-gray-400 block mb-1">Required by:</span>
                                        {% for dep in task.dependents %}
                                        <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400 mr-1 mb-1">
                                            <i class="fas fa-arrow-right mr-1"></i>
                                            {{ dep.task_title }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Labels -->
                            {% if task.labels %}
                            <div>
                                <h4 class="text-sm font-semibold text-gray-300 mb-2 flex items-center">
                                    <i class="fas fa-tags mr-2 text-pink-400"></i>
                                    Labels
                                </h4>
                                <div class="flex flex-wrap gap-1">
                                    {% for label in task.labels %}
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                        style="background-color: {{ label.color }}20; color: {{ label.color }}">
                                        <i class="{{ label.icon }} mr-1 text-xs"></i>
                                        {{ label.name }}
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="px-6 py-12 text-center">
            <div
                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-gray-700 to-gray-800 rounded-2xl mb-6">
                <i class="fas fa-tasks text-gray-400 text-2xl"></i>
            </div>
            <h3 class="text-xl font-semibold text-white mb-3">No tasks yet</h3>
            <p class="text-gray-400 mb-6">
                {% if user_permissions.can_create_tasks %}
                Start by adding your first task to this project
                {% else %}
                This project doesn't have any tasks yet. You have {{ user_role }} access.
                {% endif %}
            </p>
            {% if user_permissions.can_create_tasks %}
            <a href="{{ url_for('new_task', project_id=project.id) }}"
                class="btn-primary text-white px-6 py-3 rounded-xl font-semibold inline-flex items-center shadow-lg">
                <i class="fas fa-plus mr-2"></i>Add First Task
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Calendar View (Hidden by default) -->
    {% include 'calendar_view.html' %}
</div>

<!-- Task Assignment Modal -->
<div id="task-assignment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">Assign Task</h3>
            <button id="close-assignment-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Assign to:
                </label>
                <select id="assignment-user-select" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Unassigned</option>
                </select>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-assignment" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">
                    Cancel
                </button>
                <button id="save-assignment" class="btn-primary px-4 py-2 text-white rounded-xl font-semibold">
                    Assign Task
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Include Sharing Modals -->
    {% include 'sharing_modal.html' %}
    {% include 'collaborator_management.html' %}
</div>

<!-- Child Task Creation Modal -->
<div id="child-task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-semibold text-white">
                <i class="fas fa-plus mr-2 text-purple-400"></i>Create Child Tasks
            </h3>
            <button id="close-child-task-modal" class="text-gray-400 hover:text-white text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-4 p-4 bg-gray-800/50 rounded-lg">
            <p class="text-gray-300">
                <strong>Parent Task:</strong> <span id="parent-task-title" class="text-white"></span>
            </p>
        </div>
        
        <div class="space-y-4">
            <!-- Quick Add Section -->
            <div class="mb-6">
                <h4 class="text-lg font-semibold text-white mb-3">Quick Add Multiple Tasks</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">
                            Enter task titles (one per line):
                        </label>
                        <textarea 
                            id="child-task-titles" 
                            rows="6" 
                            class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                            placeholder="Task 1&#10;Task 2&#10;Task 3&#10;..."></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Priority</label>
                            <select id="child-task-priority" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Size</label>
                            <select id="child-task-size" class="w-full px-4 py-3 bg-gray-800 border border-gray-600 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="small">Small</option>
                                <option value="medium" selected>Medium</option>
                                <option value="large">Large</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Preview Section -->
            <div id="task-preview" class="hidden">
                <h4 class="text-lg font-semibold text-white mb-3">Preview</h4>
                <div id="preview-tasks" class="space-y-2 max-h-40 overflow-y-auto"></div>
            </div>
        </div>
        
        <div class="flex justify-end space-x-3 mt-6">
            <button id="cancel-child-tasks" class="px-6 py-3 text-gray-400 hover:text-white transition-colors">
                Cancel
            </button>
            <button id="create-child-tasks" class="btn-primary px-6 py-3 text-white rounded-xl font-semibold bg-purple-600 hover:bg-purple-700">
                <i class="fas fa-plus mr-2"></i>Create Tasks
            </button>
        </div>
    </div>
</div>

<!-- Task Flag Comment Modal -->
<div id="flag-comment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">
                <i class="fas fa-flag mr-2 text-orange-400"></i>Flag Task for Clarification
            </h3>
            <button id="close-flag-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    What needs clarification?
                </label>
                <textarea 
                    id="flag-comment-text" 
                    rows="4" 
                    class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"
                    placeholder="Please explain what needs clarification about this task..."></textarea>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button id="cancel-flag" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">
                    Cancel
                </button>
                <button id="submit-flag" class="btn-primary px-4 py-2 text-white rounded-xl font-semibold bg-orange-600 hover:bg-orange-700">
                    <i class="fas fa-flag mr-2"></i>Flag Task
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Task Flag/Discussion Modal -->
<div id="flag-discussion-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-semibold text-white">
                <i class="fas fa-flag mr-2 text-orange-400"></i>Task Discussion
            </h3>
            <button id="close-flag-discussion-modal" class="text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="space-y-4">
            <!-- Current Flag Section (if flagged) -->
            <div id="current-flag-section" class="p-4 bg-gray-800/50 rounded-lg">
                <h4 class="text-sm font-semibold text-gray-300 mb-2">Current Clarification Request:</h4>
                <p id="flag-comment-display" class="text-gray-300 text-sm mb-3"></p>
                <div class="text-xs text-gray-400">
                    <span id="flagged-by-display"></span> â€¢ <span id="flagged-at-display"></span>
                </div>
            </div>
            
            <!-- Discussion Thread -->
            <div id="discussion-thread" class="space-y-3">
                <!-- Discussion comments will be loaded here -->
            </div>
            
            <!-- Add Comment Section -->
            <div class="border-t border-gray-700 pt-4">
                <h4 class="text-sm font-semibold text-gray-300 mb-3">Add to Discussion</h4>
                <div class="space-y-3">
                    <textarea 
                        id="discussion-comment-text" 
                        rows="3" 
                        class="w-full px-4 py-3 bg-gray-800/50 border border-gray-700 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        placeholder="Add your thoughts or ask follow-up questions..."></textarea>
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-400">
                            Press Ctrl+Enter to submit
                        </div>
                        <div class="flex space-x-2">
                            <button id="submit-discussion-comment" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                                <i class="fas fa-paper-plane mr-2"></i>Add Comment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-between items-center pt-4 border-t border-gray-700">
                <div>
                    {% if user_permissions.can_resolve_flags %}
                    <button id="resolve-flag" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-check mr-2"></i>Mark as Resolved
                    </button>
                    {% endif %}
                </div>
                <div class="flex space-x-3">
                    <button id="close-flag-discussion" class="px-4 py-2 text-gray-400 hover:text-white transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- WebSocket and real-time features removed - using simple HTTP requests instead -->
<!-- Sharing Management -->
<script src="{{ url_for('static', filename='js/sharing.js') }}"></script>
<!-- Calendar View -->
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>

<style>
    /* Custom dropdown styling for better visibility */
    select {
        color: #ffffff !important;
        background-color: #1f2937 !important;
        border: 1px solid #4b5563 !important;
    }

    select option {
        background-color: #1f2937 !important;
        color: #ffffff !important;
        padding: 8px 12px !important;
    }

    select option:hover {
        background-color: #374151 !important;
    }

    select option:checked {
        background-color: #3b82f6 !important;
        color: #ffffff !important;
    }

    select:focus {
        outline: none !important;
        border-color: #3b82f6 !important;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5) !important;
    }

    /* Force visibility for all filter dropdowns */
    #status-filter,
    #workflow-filter,
    #priority-filter,
    #label-filter,
    #risk-filter,
    #assignment-filter {
        color: #ffffff !important;
        background-color: #1f2937 !important;
        border: 1px solid #4b5563 !important;
    }

    #status-filter option,
    #workflow-filter option,
    #priority-filter option,
    #label-filter option,
    #risk-filter option,
    #assignment-filter option {
        background-color: #1f2937 !important;
        color: #ffffff !important;
    }

    /* Child task modal form elements */
    #child-task-titles,
    #child-task-priority,
    #child-task-size {
        color: #ffffff !important;
        background-color: #1f2937 !important;
        border: 1px solid #4b5563 !important;
    }

    #child-task-priority option,
    #child-task-size option {
        background-color: #1f2937 !important;
        color: #ffffff !important;
    }

    /* Drag and Drop Styles */
    .sortable-ghost {
        opacity: 0.4;
        background: #374151;
    }

    .sortable-chosen {
        background: #4b5563;
    }

    .sortable-drag {
        background: #6b7280;
        transform: rotate(5deg);
    }

    /* Hierarchy View Styles */
    .hierarchy-view .task-item {
        position: relative;
    }

    .hierarchy-view .task-item[data-parent-id] {
        margin-left: 20px;
        border-left: 2px solid #374151;
        padding-left: 16px;
    }

    /* Dynamic indentation for multiple nesting levels */
    .hierarchy-view .task-item[data-parent-id] {
        position: relative;
    }

    .hierarchy-view .task-item[data-parent-id]::before {
        content: '';
        position: absolute;
        left: -2px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #374151;
    }

    /* Child task visibility and transitions */
    .task-item[data-parent-id] {
        transition: all 0.3s ease-in-out;
    }

    .child-task-visible {
        display: block !important;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Risk Level Indicators */
    .risk-indicator {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .risk-low {
        background-color: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .risk-medium {
        background-color: rgba(234, 179, 8, 0.2);
        color: #eab308;
    }

    .risk-high {
        background-color: rgba(249, 115, 22, 0.2);
        color: #f97316;
    }

    .risk-critical {
        background-color: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    /* Improved Button Styling */
    .glass {
        backdrop-filter: blur(10px);
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.3);
    }

    .glass:hover {
        background: rgba(31, 41, 55, 0.9);
        border-color: rgba(75, 85, 99, 0.5);
    }

    /* Compact Action Buttons */
    .action-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem;
        background: rgba(31, 41, 55, 0.5);
        border-radius: 0.5rem;
        border: 1px solid rgba(75, 85, 99, 0.3);
    }

    /* Filter Section Improvements */
    .filter-section {
        background: rgba(31, 41, 55, 0.6);
        border: 1px solid rgba(75, 85, 99, 0.2);
    }

    /* Task Item Improvements */
    .task-item {
        transition: all 0.2s ease;
    }

    .task-item:hover {
        background: rgba(31, 41, 55, 0.3);
        transform: translateY(-1px);
    }

    /* Professional Card Styling */
    .action-card {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 0.9) 100%);
        border: 1px solid rgba(75, 85, 99, 0.3);
        backdrop-filter: blur(20px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .action-card:hover {
        border-color: rgba(75, 85, 99, 0.5);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        transform: translateY(-2px);
    }

    /* Risk Dashboard Styling */
    .risk-card {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.8) 100%);
        border: 1px solid rgba(75, 85, 99, 0.2);
        backdrop-filter: blur(15px);
    }

    /* Task Card Improvements */
    .task-item {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.6) 0%, rgba(17, 24, 39, 0.6) 100%);
        border: 1px solid rgba(75, 85, 99, 0.2);
        backdrop-filter: blur(10px);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .task-item:hover {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.8) 100%);
        border-color: rgba(75, 85, 99, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    }

    /* User Info Styles */
    .connection-status {
        font-size: 0.875rem;
        font-weight: 500;
    }
    
    .connection-status i {
        font-size: 0.5rem;
        animation: pulse 2s infinite;
    }

    /* Active Users Styling */
    .active-user {
        position: relative;
    }

    .active-user img {
        transition: all 0.3s ease;
    }

    .active-user:hover img {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
    }

    /* Real-time Notifications */
    .notification {
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .notification.info {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
    }

    .notification.success {
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(22, 163, 74, 0.9) 100%);
    }

    .notification.warning {
        background: linear-gradient(135deg, rgba(234, 179, 8, 0.9) 0%, rgba(202, 138, 4, 0.9) 100%);
    }

    .notification.error {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.9) 0%, rgba(220, 38, 38, 0.9) 100%);
    }

    /* Conflict Resolution Dialog */
    .conflict-dialog {
        backdrop-filter: blur(20px);
        background: rgba(0, 0, 0, 0.8);
    }

    .conflict-dialog .dialog-content {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%);
        border: 1px solid rgba(75, 85, 99, 0.3);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    /* Task Update Animations */
    .task-item.updating {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%);
        border-color: rgba(59, 130, 246, 0.4);
        animation: pulse-blue 2s ease-in-out;
    }

    .task-item.new-task {
        animation: slideInFromTop 0.5s ease-out;
    }

    .task-item.deleted-task {
        animation: slideOutToLeft 0.3s ease-in forwards;
    }

    /* Project Update Animation */
    .project-updated {
        animation: pulse-green 2s ease-in-out;
    }

    /* Keyframe Animations */
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes pulse-blue {
        0%, 100% { 
            background: linear-gradient(135deg, rgba(31, 41, 55, 0.6) 0%, rgba(17, 24, 39, 0.6) 100%);
        }
        50% { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%);
        }
    }

    @keyframes pulse-green {
        0%, 100% { 
            background: transparent;
        }
        50% { 
            background: rgba(34, 197, 94, 0.1);
        }
    }

    @keyframes slideInFromTop {
        0% {
            opacity: 0;
            transform: translateY(-20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideOutToLeft {
        0% {
            opacity: 1;
            transform: translateX(0);
        }
        100% {
            opacity: 0;
            transform: translateX(-100%);
        }
    }

    /* Label Styling */
    .task-label {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.2) 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
        backdrop-filter: blur(5px);
        transition: all 0.2s ease;
    }

    .task-label:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    /* Filter Section Improvements */
    .filter-section {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.7) 0%, rgba(17, 24, 39, 0.7) 100%);
        border: 1px solid rgba(75, 85, 99, 0.2);
        backdrop-filter: blur(15px);
    }

    /* Button Improvements */
    .btn-primary {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border: 1px solid rgba(59, 130, 246, 0.3);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    /* Responsive Improvements */
    @media (max-width: 768px) {
        .action-group {
            flex-direction: column;
            gap: 0.25rem;
        }

        .glass {
            padding: 0.75rem;
        }

        .task-item {
            padding: 1rem;
        }

        .action-card {
            padding: 1rem;
        }
    }

    /* Animation Improvements */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-fadeInUp {
        animation: fadeInUp 0.6s ease-out;
    }

    /* Glass Effect Enhancement */
    .glass {
        background: rgba(31, 41, 55, 0.8);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(75, 85, 99, 0.3);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    /* Action Item Cards */
    .action-item-card {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 0.9) 100%);
        border: 1px solid rgba(75, 85, 99, 0.3);
        border-radius: 1rem;
        backdrop-filter: blur(15px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        text-decoration: none;
        display: block;
    }

    .action-item-card:hover {
        background: linear-gradient(135deg, rgba(31, 41, 55, 1) 0%, rgba(17, 24, 39, 1) 100%);
        border-color: rgba(75, 85, 99, 0.5);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        transform: translateY(-3px);
    }

    .action-item-card:active {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    /* Risk Item Cards */
    .risk-item-card {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.8) 0%, rgba(17, 24, 39, 0.8) 100%);
        border: 1px solid rgba(75, 85, 99, 0.2);
        border-radius: 0.75rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .risk-item-card:hover {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 0.9) 100%);
        border-color: rgba(75, 85, 99, 0.4);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
    }

    /* Task Details Dropdown Styles */
    .task-details-content {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.9) 0%, rgba(17, 24, 39, 0.9) 100%);
        border-top: 1px solid rgba(75, 85, 99, 0.3);
        backdrop-filter: blur(15px);
        box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .task-details-content h4 {
        color: #e5e7eb;
        font-weight: 600;
        letter-spacing: 0.025em;
    }

    .task-details-content .text-gray-300 {
        color: #d1d5db;
        line-height: 1.6;
    }

    .task-details-content .text-gray-400 {
        color: #9ca3af;
    }

    /* Smooth dropdown animation */
    .task-details-content {
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
    }

    /* Chevron rotation animation */
    .task-details-toggle i {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Hover effects for dropdown sections */
    .task-details-content > div > div:hover {
        background: rgba(55, 65, 81, 0.1);
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin: -0.5rem;
        transition: all 0.2s ease;
    }
</style>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const generateTasksBtn = document.getElementById('generate-tasks-btn');
        const manageLabelsBtn = document.getElementById('manage-labels-btn');
        // Removed manageDependenciesBtn and riskDashboardBtn as they're no longer needed
        const toggleDragDropBtn = document.getElementById('toggle-drag-drop-btn');

        // Advanced Task Management State
        let isDragDropEnabled = false;
        let isHierarchyView = false; // Show flat list view by default
        
        // Initialize task hierarchy state
        initializeTaskHierarchy();
        let sortableInstance = null;

        // Generate Starter Tasks functionality
        if (generateTasksBtn) {
            generateTasksBtn.addEventListener('click', async function () {
                if (!confirm('This will generate AI-powered starter tasks based on your project brief. Continue?')) {
                    return;
                }

                generateTasksBtn.disabled = true;
                generateTasksBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';

                try {
                    const response = await fetch(`/projects/{{ project.id }}/generate-tasks`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert(`Success! ${data.message}`);
                        // Reload the page to show new tasks
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                } catch (error) {
                    alert('Error generating tasks: ' + error.message);
                } finally {
                    generateTasksBtn.disabled = false;
                    generateTasksBtn.innerHTML = '<i class="fas fa-robot mr-1"></i>Generate Starter Tasks';
                }
            });
        }

        // Generate AI Summary functionality moved to Quick Actions section (ai-summary-btn handler)

    function showSummaryModal(summary) {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">AI Project Summary</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="text-gray-300 leading-relaxed whitespace-pre-line">${summary}</div>
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Manage Labels functionality
    if (manageLabelsBtn) {
        manageLabelsBtn.addEventListener('click', function () {
            showLabelsModal();
        });
    }

    // Advanced Task Management Event Listeners
    if (toggleDragDropBtn) {
        toggleDragDropBtn.addEventListener('click', toggleDragDrop);
    }

    // Initialize risk dashboard on page load
    initializeRiskDashboard();

    // Workflow button functionality
    document.addEventListener('click', function (e) {
        if (e.target.closest('.workflow-btn')) {
            const button = e.target.closest('.workflow-btn');
            const taskId = button.dataset.taskId;
            const workflowStatus = button.dataset.workflowStatus;
            handleWorkflowTransition(taskId, workflowStatus, button);
        }
        
        if (e.target.closest('.reset-workflow-btn')) {
            const button = e.target.closest('.reset-workflow-btn');
            const taskId = button.dataset.taskId;
            handleWorkflowReset(taskId, button);
        }
        
        if (e.target.closest('.create-child-task-btn')) {
            const button = e.target.closest('.create-child-task-btn');
            const taskId = button.dataset.taskId;
            const taskTitle = button.dataset.taskTitle;
            showChildTaskModal(taskId, taskTitle);
        }
    });

    // Hierarchy expand/collapse functionality
    document.addEventListener('click', function (e) {
        if (e.target.closest('.expand-toggle')) {
            const button = e.target.closest('.expand-toggle');
            const taskId = button.dataset.taskId;
            toggleTaskExpansion(taskId);
        }

        if (e.target.closest('.manage-dependencies')) {
            const button = e.target.closest('.manage-dependencies');
            const taskId = button.dataset.taskId;
            showTaskDependenciesModal(taskId);
        }

        // Task details dropdown toggle
        if (e.target.closest('.task-details-toggle')) {
            const button = e.target.closest('.task-details-toggle');
            const taskId = button.dataset.taskId;
            toggleTaskDetails(taskId);
        }
    });

    // Filter functionality
    const workflowFilterButtons = document.querySelectorAll('.workflow-filter-btn');
    const priorityFilter = document.getElementById('priority-filter');
    const labelFilter = document.getElementById('label-filter');
    const riskFilter = document.getElementById('risk-filter');
    const assignmentFilter = document.getElementById('assignment-filter');
    const searchInput = document.getElementById('search-tasks');
    const advancedFiltersToggle = document.getElementById('advanced-filters-toggle');
    const advancedFiltersPanel = document.getElementById('advanced-filters-panel');
    const closeFiltersPanel = document.getElementById('close-filters-panel');
    const clearAllFiltersBtn = document.getElementById('clear-all-filters');

    // Workflow filter button event listeners
    workflowFilterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            workflowFilterButtons.forEach(btn => btn.classList.remove('active'));
            // Add active class to clicked button
            this.classList.add('active');
            filterTasks();
        });
    });

    // Advanced filters side panel toggle
    if (advancedFiltersToggle && advancedFiltersPanel) {
        advancedFiltersToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            openFiltersPanel();
        });
    }

    // Close filters panel
    if (closeFiltersPanel) {
        closeFiltersPanel.addEventListener('click', function() {
            closeFiltersPanelFunction();
        });
    }

    // Close panel with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !advancedFiltersPanel.classList.contains('-translate-x-full')) {
            closeFiltersPanelFunction();
        }
    });

    function openFiltersPanel() {
        advancedFiltersPanel.classList.remove('-translate-x-full');
        // No overlay, no body scroll prevention - allow full interaction
    }

    function closeFiltersPanelFunction() {
        advancedFiltersPanel.classList.add('-translate-x-full');
        // No overlay to hide
    }

    // Other filter event listeners
    [priorityFilter, labelFilter, riskFilter, assignmentFilter, searchInput].forEach(element => {
        if (element) {
            element.addEventListener('change', filterTasks);
            element.addEventListener('input', filterTasks);
        }
    });

    // Control Panel Enhanced Functionality
    const dueDateFilter = document.getElementById('due-date-filter');
    const createdDateFilter = document.getElementById('created-date-filter');
    const calendarViewBtn = document.getElementById('calendar-view-btn');
    const aiSummaryBtn = document.getElementById('ai-summary-btn');
    const manageCollaboratorsBtn = document.getElementById('manage-collaborators-btn');

    // Quick Actions
    if (calendarViewBtn) {
        calendarViewBtn.addEventListener('click', function() {
            toggleCalendarView();
        });
    }

    if (aiSummaryBtn) {
        aiSummaryBtn.addEventListener('click', async function() {
            aiSummaryBtn.disabled = true;
            aiSummaryBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Generating...';

            try {
                const response = await fetch('/api/generate-summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        project_id: {{ project.id|tojson }}
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show summary in a modal or alert
                    showSummaryModal(data.summary);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error generating summary: ' + error.message);
            } finally {
                aiSummaryBtn.disabled = false;
                aiSummaryBtn.innerHTML = '<i class="fas fa-robot mr-1"></i>AI Summary';
            }
        });
    }

    // manageCollaboratorsBtn is handled by SharingManager in sharing.js
    // No need to add handler here as it's already set up via event delegation


    // Due date filter
    if (dueDateFilter) {
        dueDateFilter.addEventListener('change', filterTasks);
    }

    // Created date filter
    if (createdDateFilter) {
        createdDateFilter.addEventListener('change', filterTasks);
    }

    // Helper functions

    // Removed unused functions - export/import now handled by server-side routes

    // Clear all filters button
    if (clearAllFiltersBtn) {
        clearAllFiltersBtn.addEventListener('click', function() {
            clearAllFilters();
        });
    }

    function filterTasks() {
        // Get active workflow filter
        const activeWorkflowButton = document.querySelector('.workflow-filter-btn.active');
        const workflowValue = activeWorkflowButton ? activeWorkflowButton.dataset.workflow : '';
        
        const priorityValue = priorityFilter.value;
        const labelValue = labelFilter.value;
        const riskValue = riskFilter.value;
        const assignmentValue = assignmentFilter.value;
        const dueDateValue = dueDateFilter.value;
        const createdDateValue = createdDateFilter.value;
        const searchValue = searchInput.value.toLowerCase();

        const taskElements = document.querySelectorAll('#tasks-list .task-item');
        let visibleCount = 0;

        taskElements.forEach(taskElement => {
            const taskTitle = taskElement.querySelector('h3 a').textContent.toLowerCase();
            const taskPriority = taskElement.querySelector('.text-red-400, .text-yellow-400, .text-green-400')?.textContent.toLowerCase() || '';
            const taskLabels = Array.from(taskElement.querySelectorAll('[style*="background-color"]')).map(label => label.textContent.toLowerCase());
            const taskRiskLevel = taskElement.dataset.riskLevel || 'low';
            const taskParentId = taskElement.dataset.parentId;

            let showTask = true;

            // When "All Tasks" is selected (no workflowValue), only show parent tasks (no parent_id)
            if (!workflowValue && taskParentId) {
                showTask = false;
            }

            // Workflow filter
            if (workflowValue) {
                const taskWorkflowStatus = taskElement.querySelector('.workflow-btn')?.dataset.workflowStatus;
                if (taskWorkflowStatus !== workflowValue) {
                    showTask = false;
                }
            }

            // Priority filter
            if (priorityValue && !taskPriority.includes(priorityValue)) {
                showTask = false;
            }

            // Risk filter
            if (riskValue && taskRiskLevel !== riskValue) {
                showTask = false;
            }

            // Label filter
            if (labelValue) {
                const hasLabel = taskLabels.some(label => {
                    // Find the label name by ID
                    const labelOption = labelFilter.querySelector(`option[value="${labelValue}"]`);
                    return labelOption && label.toLowerCase().includes(labelOption.textContent.toLowerCase());
                });
                if (!hasLabel) {
                    showTask = false;
                }
            }

            // Assignment filter
            if (assignmentValue === 'assigned') {
                // Check if task is assigned to current user
                const currentUserId = document.querySelector('[data-user-id]')?.dataset.userId;
                const taskAssignedTo = taskElement.querySelector('.assign-task')?.dataset.assignedTo;
                
                // Debug logging
                console.log('Assignment filter debug:', {
                    currentUserId,
                    taskAssignedTo,
                    taskTitle: taskElement.querySelector('h3 a').textContent,
                    match: taskAssignedTo === currentUserId
                });
                
                // Task must be assigned and assigned to current user
                if (!taskAssignedTo || taskAssignedTo !== currentUserId) {
                    showTask = false;
                }
            }


            // Due date filter
            if (dueDateValue) {
                const taskDueDate = taskElement.querySelector('.due-date')?.textContent;
                if (dueDateValue === 'no_date' && taskDueDate) {
                    showTask = false;
                } else if (dueDateValue === 'overdue') {
                    if (!taskDueDate || new Date(taskDueDate) >= new Date()) {
                        showTask = false;
                    }
                } else if (dueDateValue === 'due_today') {
                    const today = new Date();
                    const dueDate = new Date(taskDueDate);
                    if (!taskDueDate || dueDate.toDateString() !== today.toDateString()) {
                        showTask = false;
                    }
                } else if (dueDateValue === 'due_this_week') {
                    if (!taskDueDate) {
                        showTask = false;
                    } else {
                        const dueDate = new Date(taskDueDate);
                        const today = new Date();
                        const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
                        if (dueDate < today || dueDate > weekFromNow) {
                            showTask = false;
                        }
                    }
                }
            }

            // Created date filter
            if (createdDateValue) {
                const taskCreatedDate = taskElement.querySelector('.created-date')?.textContent;
                if (createdDateValue === 'today') {
                    if (!taskCreatedDate) {
                        showTask = false;
                    } else {
                        const createdDate = new Date(taskCreatedDate);
                        const today = new Date();
                        if (createdDate.toDateString() !== today.toDateString()) {
                            showTask = false;
                        }
                    }
                } else if (createdDateValue === 'this_week') {
                    if (!taskCreatedDate) {
                        showTask = false;
                    } else {
                        const createdDate = new Date(taskCreatedDate);
                        const today = new Date();
                        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (createdDate < weekAgo || createdDate > today) {
                            showTask = false;
                        }
                    }
                } else if (createdDateValue === 'this_month') {
                    if (!taskCreatedDate) {
                        showTask = false;
                    } else {
                        const createdDate = new Date(taskCreatedDate);
                        const today = new Date();
                        const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                        if (createdDate < monthAgo || createdDate > today) {
                            showTask = false;
                        }
                    }
                }
            }

            // Search filter
            if (searchValue && !taskTitle.includes(searchValue)) {
                showTask = false;
            }

            if (showTask) {
                taskElement.style.display = 'block';
                visibleCount++;
            } else {
                taskElement.style.display = 'none';
            }
        });

        // Update task count
        const taskCountElement = document.getElementById('task-count');
        if (taskCountElement) {
            taskCountElement.textContent = visibleCount;
        }
    }

    // Clear filters function
    window.clearFilters = function () {
        // Reset workflow filter to "All Tasks"
        workflowFilterButtons.forEach(btn => btn.classList.remove('active'));
        const allTasksBtn = document.getElementById('workflow-all');
        if (allTasksBtn) {
            allTasksBtn.classList.add('active');
        }
        
        // Clear other filters
        priorityFilter.value = '';
        labelFilter.value = '';
        riskFilter.value = '';
        assignmentFilter.value = '';
        dueDateFilter.value = '';
        createdDateFilter.value = '';
        searchInput.value = '';
        
        // Close advanced filters dropdown
        if (advancedFiltersDropdown) {
            advancedFiltersDropdown.classList.add('hidden');
            const chevron = advancedFiltersToggle?.querySelector('.fa-chevron-down');
            if (chevron) {
                chevron.style.transform = 'rotate(0deg)';
            }
        }
        
        filterTasks();
    };

    // Workflow transition function
    async function handleWorkflowTransition(taskId, currentStatus, button) {
        if (!taskId || !currentStatus) {
            console.error('Missing task ID or workflow status');
            return;
        }

        // Disable button during transition
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Processing...';

        try {
            let endpoint;
            if (currentStatus === 'backlog') {
                endpoint = `/api/projects/{{ project.id }}/tasks/${taskId}/workflow/start`;
            } else if (currentStatus === 'in_progress') {
                endpoint = `/api/projects/{{ project.id }}/tasks/${taskId}/workflow/commit`;
            } else if (currentStatus === 'committed') {
                endpoint = `/api/projects/{{ project.id }}/tasks/${taskId}/workflow/complete`;
            } else {
                throw new Error('Invalid workflow status for transition');
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Update button appearance
                button.dataset.workflowStatus = data.workflow_status;
                button.innerHTML = `<i class="fas fa-play mr-1"></i>${data.button_text}`;
                button.className = `workflow-btn px-3 py-1.5 text-xs font-medium text-white rounded-md transition-all duration-200 ${data.button_class}`;
                
                // Show success message
                showNotification(data.message, 'success');
                
                // Refresh task count
                filterTasks();
            } else {
                throw new Error(data.error || 'Failed to update workflow');
            }
        } catch (error) {
            console.error('Workflow transition error:', error);
            showNotification(error.message || 'Failed to update workflow', 'error');
            
            // Restore original button state
            button.innerHTML = originalText;
        } finally {
            button.disabled = false;
        }
    }

    // Workflow reset function
    async function handleWorkflowReset(taskId, button) {
        if (!taskId) {
            console.error('Missing task ID');
            return;
        }

        // Confirm reset action
        if (!confirm('Are you sure you want to reset this task workflow?\n\nThis will move the task back to "Backlog" status and you can start the workflow again from the beginning.')) {
            return;
        }

        // Disable button during reset
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Resetting...';

        try {
            const endpoint = `/api/projects/{{ project.id }}/tasks/${taskId}/workflow/reset`;

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Update workflow button
                const workflowBtn = document.querySelector(`.workflow-btn[data-task-id="${taskId}"]`);
                if (workflowBtn) {
                    workflowBtn.dataset.workflowStatus = data.workflow_status;
                    workflowBtn.innerHTML = `<i class="fas fa-play mr-1"></i>${data.button_text}`;
                    workflowBtn.className = `workflow-btn px-3 py-1.5 text-xs font-medium text-white rounded-md transition-all duration-200 ${data.button_class}`;
                }
                
                // Hide reset button since task is no longer completed
                button.style.display = 'none';
                
                // Show success message
                showNotification(data.message, 'success');
                
                // Refresh task count
                filterTasks();
            } else {
                throw new Error(data.error || 'Failed to reset workflow');
            }
        } catch (error) {
            console.error('Workflow reset error:', error);
            showNotification(error.message || 'Failed to reset workflow', 'error');
            
            // Restore original button state
            button.innerHTML = originalText;
        } finally {
            button.disabled = false;
        }
    }

    // Child Task Creation Functions
    let currentParentTaskId = null;

    function showChildTaskModal(parentTaskId, parentTaskTitle) {
        currentParentTaskId = parentTaskId;
        document.getElementById('parent-task-title').textContent = parentTaskTitle;
        document.getElementById('child-task-modal').classList.remove('hidden');
        
        // Clear previous data
        document.getElementById('child-task-titles').value = '';
        document.getElementById('child-task-priority').value = 'medium';
        document.getElementById('child-task-size').value = 'medium';
        document.getElementById('task-preview').classList.add('hidden');
        
        // Focus on textarea
        document.getElementById('child-task-titles').focus();
    }

    function hideChildTaskModal() {
        document.getElementById('child-task-modal').classList.add('hidden');
        currentParentTaskId = null;
    }

    function updateTaskPreview() {
        const titles = document.getElementById('child-task-titles').value.trim();
        const priority = document.getElementById('child-task-priority').value;
        const size = document.getElementById('child-task-size').value;
        
        if (!titles) {
            document.getElementById('task-preview').classList.add('hidden');
            return;
        }
        
        const taskTitles = titles.split('\n').filter(title => title.trim());
        const previewContainer = document.getElementById('preview-tasks');
        
        previewContainer.innerHTML = taskTitles.map((title, index) => `
            <div class="flex items-center space-x-3 p-3 bg-gray-800/50 rounded-lg">
                <div class="w-6 h-6 bg-purple-600 rounded-full flex items-center justify-center text-white text-xs font-semibold">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <div class="text-white font-medium">${title.trim()}</div>
                    <div class="text-sm text-gray-400">${priority} â€¢ ${size}</div>
                </div>
            </div>
        `).join('');
        
        document.getElementById('task-preview').classList.remove('hidden');
    }

    async function createChildTasks() {
        const titles = document.getElementById('child-task-titles').value.trim();
        const priority = document.getElementById('child-task-priority').value;
        const size = document.getElementById('child-task-size').value;
        
        if (!titles || !currentParentTaskId) {
            showNotification('Please enter at least one task title', 'error');
            return;
        }
        
        const taskTitles = titles.split('\n').filter(title => title.trim());
        if (taskTitles.length === 0) {
            showNotification('Please enter at least one valid task title', 'error');
            return;
        }
        
        const createButton = document.getElementById('create-child-tasks');
        const originalText = createButton.innerHTML;
        createButton.disabled = true;
        createButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
        try {
            const response = await fetch(`/api/projects/{{ project.id }}/tasks/batch-create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    parent_id: currentParentTaskId,
                    tasks: taskTitles.map(title => ({
                        title: title.trim(),
                        priority: priority,
                        size: size,
                        status: 'backlog',
                        workflow_status: 'backlog'
                    }))
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showNotification(`Successfully created ${data.created_count} child tasks`, 'success');
                hideChildTaskModal();
                
                // Refresh the page to show new tasks
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.error || 'Failed to create child tasks');
            }
        } catch (error) {
            console.error('Child task creation error:', error);
            showNotification(error.message || 'Failed to create child tasks', 'error');
        } finally {
            createButton.disabled = false;
            createButton.innerHTML = originalText;
        }
    }

    // Event listeners for child task modal
    document.getElementById('close-child-task-modal').addEventListener('click', hideChildTaskModal);
    document.getElementById('cancel-child-tasks').addEventListener('click', hideChildTaskModal);
    document.getElementById('create-child-tasks').addEventListener('click', createChildTasks);
    document.getElementById('child-task-titles').addEventListener('input', updateTaskPreview);
    document.getElementById('child-task-priority').addEventListener('change', updateTaskPreview);
    document.getElementById('child-task-size').addEventListener('change', updateTaskPreview);

    // Close modal when clicking outside
    document.getElementById('child-task-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideChildTaskModal();
        }
    });

    // Advanced Task Management Functions

    // Calculate nesting levels for all tasks
    function calculateNestingLevels() {
        const taskItems = document.querySelectorAll('.task-item');
        const taskMap = new Map();
        
        // First pass: build a map of all tasks
        taskItems.forEach(taskItem => {
            const taskId = taskItem.dataset.taskId;
            const parentId = taskItem.dataset.parentId;
            taskMap.set(taskId, { element: taskItem, parentId: parentId || null });
        });
        
        // Second pass: calculate nesting levels
        function getNestingLevel(taskId, visited = new Set()) {
            if (visited.has(taskId)) {
                return 0; // Prevent infinite recursion
            }
            visited.add(taskId);
            
            const task = taskMap.get(taskId);
            if (!task || !task.parentId) {
                return 0;
            }
            
            return 1 + getNestingLevel(task.parentId, visited);
        }
        
        // Apply nesting levels
        taskItems.forEach(taskItem => {
            const taskId = taskItem.dataset.taskId;
            const nestingLevel = getNestingLevel(taskId);
            taskItem.dataset.nestingLevel = nestingLevel;
            
            if (nestingLevel > 0) {
                taskItem.style.setProperty('--nesting-level', nestingLevel);
                taskItem.style.marginLeft = `calc(20px * ${nestingLevel})`;
            }
        });
    }

    // Initialize task hierarchy state on page load
    function initializeTaskHierarchy() {
        // Calculate nesting levels first
        calculateNestingLevels();
        
        // Set up expand/collapse buttons based on database state
        document.querySelectorAll('.expand-toggle').forEach(btn => {
            btn.style.display = 'block'; // Always show expand/collapse buttons
            const taskId = btn.dataset.taskId;
            const taskItem = document.querySelector(`[data-task-id="${taskId}"].task-item`);
            const isExpanded = taskItem.dataset.isExpanded === 'true';
            const icon = btn.querySelector('i');
            
            if (isExpanded) {
                icon.style.transform = 'rotate(90deg)';
                showChildTasks(taskId);
            } else {
                icon.style.transform = 'rotate(0deg)';
                hideChildTasks(taskId);
            }
        });
    }


    // Toggle Drag & Drop
    function toggleDragDrop() {
        isDragDropEnabled = !isDragDropEnabled;
        const tasksContainer = document.getElementById('tasks-container');

        if (isDragDropEnabled) {
            toggleDragDropBtn.innerHTML = '<i class="fas fa-lock mr-1"></i>Disable Drag';
            // Show drag handles
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.style.display = 'block';
            });

            // Initialize Sortable
            if (!sortableInstance) {
                sortableInstance = new Sortable(tasksContainer, {
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        // Update task order
                        updateTaskOrder();
                    }
                });
            }
        } else {
            toggleDragDropBtn.innerHTML = '<i class="fas fa-arrows-alt mr-1"></i>Drag & Drop';
            // Hide drag handles
            document.querySelectorAll('.drag-handle').forEach(handle => {
                handle.style.display = 'none';
            });

            // Destroy Sortable instance
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
            }
        }
    }

    // Update Task Order
    async function updateTaskOrder() {
        const taskItems = document.querySelectorAll('.task-item');
        const taskOrders = Array.from(taskItems).map((item, index) => ({
            task_id: parseInt(item.dataset.taskId),
            sort_order: index + 1
        }));

        try {
            const response = await fetch(`/api/projects/{{ project.id }}/tasks/reorder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ task_orders: taskOrders })
            });

            if (!response.ok) {
                const error = await response.json();
                alert('Error reordering tasks: ' + error.error);
            }
        } catch (error) {
            alert('Error reordering tasks: ' + error.message);
        }
    }

    // Toggle Task Expansion
    async function toggleTaskExpansion(taskId) {
        try {
            const response = await fetch(`/api/projects/{{ project.id }}/tasks/${taskId}/toggle-expand`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            if (response.ok) {
                const data = await response.json();
                const button = document.querySelector(`[data-task-id="${taskId}"].expand-toggle`);
                const icon = button.querySelector('i');

                if (data.is_expanded) {
                    icon.style.transform = 'rotate(90deg)';
                    showChildTasks(taskId);
                } else {
                    icon.style.transform = 'rotate(0deg)';
                    hideChildTasks(taskId);
                }
            }
        } catch (error) {
            alert('Error toggling task expansion: ' + error.message);
        }
    }

    // Show child tasks for a parent task (recursive - shows all descendants)
    function showChildTasks(parentTaskId) {
        const childTasks = document.querySelectorAll(`[data-parent-id="${parentTaskId}"]`);
        childTasks.forEach(childTask => {
            childTask.style.display = 'block';
            childTask.classList.add('child-task-visible');
            
            // Recursively show children of this child task if it's expanded
            const childTaskId = childTask.dataset.taskId;
            const childExpandButton = childTask.querySelector('.expand-toggle');
            if (childExpandButton) {
                const childIcon = childExpandButton.querySelector('i');
                const isChildExpanded = childIcon.style.transform === 'rotate(90deg)';
                if (isChildExpanded) {
                    showChildTasks(childTaskId);
                }
            }
        });
    }

    // Hide child tasks for a parent task (recursive - hides all descendants)
    function hideChildTasks(parentTaskId) {
        const childTasks = document.querySelectorAll(`[data-parent-id="${parentTaskId}"]`);
        childTasks.forEach(childTask => {
            childTask.style.display = 'none';
            childTask.classList.remove('child-task-visible');
            
            // Recursively hide all descendants
            const childTaskId = childTask.dataset.taskId;
            hideChildTasks(childTaskId);
        });
    }

    // Toggle Task Details Dropdown
    function toggleTaskDetails(taskId) {
        const taskItem = document.querySelector(`[data-task-id="${taskId}"].task-item`);
        const detailsContent = taskItem.querySelector('.task-details-content');
        const toggleButton = taskItem.querySelector('.task-details-toggle');
        const chevronIcon = toggleButton.querySelector('i');

        if (detailsContent.classList.contains('hidden')) {
            // Show details
            detailsContent.classList.remove('hidden');
            chevronIcon.style.transform = 'rotate(180deg)';
            toggleButton.title = 'Hide Task Details';
            
            // Add smooth animation
            detailsContent.style.maxHeight = '0';
            detailsContent.style.overflow = 'hidden';
            detailsContent.style.transition = 'max-height 0.3s ease-out';
            
            // Trigger reflow
            detailsContent.offsetHeight;
            
            // Set final height
            detailsContent.style.maxHeight = detailsContent.scrollHeight + 'px';
            
            // Remove height constraint after animation
            setTimeout(() => {
                detailsContent.style.maxHeight = 'none';
                detailsContent.style.overflow = 'visible';
            }, 300);
        } else {
            // Hide details
            detailsContent.style.maxHeight = detailsContent.scrollHeight + 'px';
            detailsContent.style.overflow = 'hidden';
            detailsContent.style.transition = 'max-height 0.3s ease-in';
            
            // Trigger reflow
            detailsContent.offsetHeight;
            
            // Collapse
            detailsContent.style.maxHeight = '0';
            
            setTimeout(() => {
                detailsContent.classList.add('hidden');
                detailsContent.style.maxHeight = 'none';
                detailsContent.style.overflow = 'visible';
                detailsContent.style.transition = 'none';
            }, 300);
            
            chevronIcon.style.transform = 'rotate(0deg)';
            toggleButton.title = 'View Task Details';
        }
    }


    // Show Task Dependencies Modal
    function showTaskDependenciesModal(taskId) {
        // Implementation for individual task dependency management
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Manage Dependencies</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="text-gray-300">
                    <p>Dependency management for task ID: ${taskId}</p>
                    <p class="mt-2">This feature will be fully implemented in the next phase.</p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                        Close
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Initialize Risk Dashboard
    function initializeRiskDashboard() {
        const tasks = {{ tasks_data|tojson }};
        const riskStats = {
        low: 0,
        medium: 0,
        high: 0,
        critical: 0
    };

    tasks.forEach(task => {
        const riskLevel = task.risk_level || 'low'; // Ensure we have a risk level
        riskStats[riskLevel] = (riskStats[riskLevel] || 0) + 1;
    });

    // Update the risk counts in the dashboard
    const lowCountElement = document.getElementById('risk-low-count');
    const mediumCountElement = document.getElementById('risk-medium-count');
    const highCountElement = document.getElementById('risk-high-count');
    const criticalCountElement = document.getElementById('risk-critical-count');

    if (lowCountElement) lowCountElement.textContent = riskStats.low;
    if (mediumCountElement) mediumCountElement.textContent = riskStats.medium;
    if (highCountElement) highCountElement.textContent = riskStats.high;
    if (criticalCountElement) criticalCountElement.textContent = riskStats.critical;
    }

    // Show Detailed Risk Dashboard
    function showDetailedRiskDashboard() {
        const tasks = {{ tasks_data|tojson }};
        let riskStats = {
            low: 0,
            medium: 0,
            high: 0,
            critical: 0
        };

    tasks.forEach(task => {
        riskStats[task.risk_level] = (riskStats[task.risk_level] || 0) + 1;
    });

    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl p-8 max-w-4xl mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Detailed Risk Analysis</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-700/50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-green-400">${riskStats.low}</div>
                        <div class="text-sm text-gray-300">Low Risk</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-400">${riskStats.medium}</div>
                        <div class="text-sm text-gray-300">Medium Risk</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-orange-400">${riskStats.high}</div>
                        <div class="text-sm text-gray-300">High Risk</div>
                    </div>
                    <div class="bg-gray-700/50 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-red-400">${riskStats.critical}</div>
                        <div class="text-sm text-gray-300">Critical Risk</div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" class="btn-primary text-white px-6 py-3 rounded-xl font-semibold">
                        Close
                    </button>
                </div>
            </div>
        `;
    document.body.appendChild(modal);
    }

    async function showLabelsModal() {
        try {
            // Clear any existing dynamically created modals first (but preserve predefined modals)
            document.querySelectorAll('.fixed:not(#sharing-modal):not(#collaborator-modal):not(#activity-log-modal):not(#ai-panel):not(#advanced-filters-toggle):not(#advanced-filters-panel)').forEach(modal => modal.remove());
            
            // Fetch current labels
            const response = await fetch(`/projects/{{ project.id }}/labels`);
            const data = await response.json();

            if (response.ok) {
                createLabelsModal(data.labels);
            } else {
                alert('Error loading labels: ' + data.error);
            }
        } catch (error) {
            alert('Error loading labels: ' + error.message);
        }
    }

    function createLabelsModal(labels) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl p-8 max-w-4xl mx-4 max-h-96 overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Manage Labels</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <!-- Add New Label Form -->
                <div class="mb-6 p-4 bg-gray-700/50 rounded-xl">
                    <h4 class="text-lg font-semibold text-white mb-4">Add New Label</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input type="text" id="new-label-name" placeholder="Label name" 
                               class="px-3 py-2 rounded-lg focus:outline-none">
                        <input type="color" id="new-label-color" value="#3B82F6" 
                               class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
                        <select id="new-label-icon" class="px-3 py-2 rounded-lg focus:outline-none">
                            <option value="fas fa-tag">Tag</option>
                            <option value="fas fa-bug">Bug</option>
                            <option value="fas fa-star">Star</option>
                            <option value="fas fa-fire">Fire</option>
                            <option value="fas fa-heart">Heart</option>
                            <option value="fas fa-rocket">Rocket</option>
                            <option value="fas fa-lightbulb">Lightbulb</option>
                            <option value="fas fa-check">Check</option>
                            <option value="fas fa-exclamation">Exclamation</option>
                            <option value="fas fa-question">Question</option>
                        </select>
                        <button onclick="addNewLabel()" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold">
                            <i class="fas fa-plus mr-2"></i>Add Label
                        </button>
                    </div>
                </div>
                
                <!-- Existing Labels -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-white">Existing Labels</h4>
                    <div id="labels-list" class="space-y-2">
                        ${labels.map(label => `
                            <div class="flex items-center justify-between p-3 bg-gray-700/30 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i class="${label.icon}" style="color: ${label.color}"></i>
                                    <span class="text-white">${label.name}</span>
                                    <span class="text-gray-400 text-sm">(${label.task_count} tasks)</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editLabel(${label.id})" class="text-blue-400 hover:text-blue-300 p-1">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteLabel(${label.id})" class="text-red-400 hover:text-red-300 p-1">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Global functions for label management
    window.addNewLabel = async function () {
        const name = document.getElementById('new-label-name').value.trim();
        const color = document.getElementById('new-label-color').value;
        const icon = document.getElementById('new-label-icon').value;

        if (!name) {
            alert('Please enter a label name');
            return;
        }

        try {
            const response = await fetch(`/projects/{{ project.id }}/labels`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, color, icon })
            });

            const data = await response.json();

            if (response.ok) {
                // Clear all existing dynamically created modals and refresh (but preserve predefined modals)
                document.querySelectorAll('.fixed:not(#sharing-modal):not(#collaborator-modal):not(#activity-log-modal):not(#ai-panel):not(#advanced-filters-toggle):not(#advanced-filters-panel)').forEach(modal => modal.remove());
                showLabelsModal();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error creating label: ' + error.message);
        }
    };

    window.editLabel = async function (labelId) {
        // Find the label data
        const labels = await fetch(`/projects/{{ project.id }}/labels`).then(r => r.json()).then(d => d.labels);
        const label = labels.find(l => l.id === labelId);
        
        if (!label) {
            alert('Label not found');
            return;
        }

        // Create edit modal
        const editModal = document.createElement('div');
        editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        editModal.innerHTML = `
            <div class="bg-gray-800 rounded-2xl p-8 max-w-2xl mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-white">Edit Label</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Label Name</label>
                        <input type="text" id="edit-label-name" value="${label.name}" 
                               class="w-full px-3 py-2 rounded-lg focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Color</label>
                        <input type="color" id="edit-label-color" value="${label.color}" 
                               class="px-3 py-2 bg-gray-800 border border-gray-600 rounded-lg">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Icon</label>
                        <select id="edit-label-icon" class="w-full px-3 py-2 rounded-lg focus:outline-none">
                            <option value="fas fa-tag" ${label.icon === 'fas fa-tag' ? 'selected' : ''}>Tag</option>
                            <option value="fas fa-bug" ${label.icon === 'fas fa-bug' ? 'selected' : ''}>Bug</option>
                            <option value="fas fa-star" ${label.icon === 'fas fa-star' ? 'selected' : ''}>Star</option>
                            <option value="fas fa-fire" ${label.icon === 'fas fa-fire' ? 'selected' : ''}>Fire</option>
                            <option value="fas fa-heart" ${label.icon === 'fas fa-heart' ? 'selected' : ''}>Heart</option>
                            <option value="fas fa-rocket" ${label.icon === 'fas fa-rocket' ? 'selected' : ''}>Rocket</option>
                            <option value="fas fa-lightbulb" ${label.icon === 'fas fa-lightbulb' ? 'selected' : ''}>Lightbulb</option>
                            <option value="fas fa-check" ${label.icon === 'fas fa-check' ? 'selected' : ''}>Check</option>
                            <option value="fas fa-exclamation" ${label.icon === 'fas fa-exclamation' ? 'selected' : ''}>Exclamation</option>
                            <option value="fas fa-question" ${label.icon === 'fas fa-question' ? 'selected' : ''}>Question</option>
                        </select>
                    </div>
                    
                    <div class="flex justify-end space-x-4 pt-4">
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Cancel
                        </button>
                        <button onclick="updateLabel(${labelId})" class="btn-primary text-white px-6 py-2 rounded-lg font-semibold">
                            <i class="fas fa-save mr-2"></i>Update Label
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(editModal);
    };

    window.updateLabel = async function (labelId) {
        const name = document.getElementById('edit-label-name').value.trim();
        const color = document.getElementById('edit-label-color').value;
        const icon = document.getElementById('edit-label-icon').value;

        if (!name) {
            alert('Please enter a label name');
            return;
        }

        try {
            const response = await fetch(`/projects/{{ project.id }}/labels/${labelId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, color, icon })
            });

            const data = await response.json();

            if (response.ok) {
                // Clear all existing dynamically created modals and refresh (but preserve predefined modals)
                document.querySelectorAll('.fixed:not(#sharing-modal):not(#collaborator-modal):not(#activity-log-modal):not(#ai-panel):not(#advanced-filters-toggle):not(#advanced-filters-panel)').forEach(modal => modal.remove());
                showLabelsModal();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error updating label: ' + error.message);
        }
    };

    window.deleteLabel = async function (labelId) {
        if (!confirm('Are you sure you want to delete this label? This will remove it from all tasks.')) {
            return;
        }

        try {
            const response = await fetch(`/projects/{{ project.id }}/labels/${labelId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                // Clear all existing dynamically created modals and refresh (but preserve predefined modals)
                document.querySelectorAll('.fixed:not(#sharing-modal):not(#collaborator-modal):not(#activity-log-modal):not(#ai-panel):not(#advanced-filters-toggle):not(#advanced-filters-panel)').forEach(modal => modal.remove());
                showLabelsModal();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error deleting label: ' + error.message);
        }
    };
});

    function toggleCalendarView() {
        const tasksList = document.getElementById('tasks-list');
        const calendarView = document.getElementById('calendar-view');
        
        if (calendarView.style.display === 'none') {
            tasksList.style.display = 'none';
            calendarView.style.display = 'block';
            initializeCalendarView();
        } else {
            tasksList.style.display = 'block';
            calendarView.style.display = 'none';
        }
    }

    function initializeCalendarView() {
        // Initialize calendar with tasks data
        const tasksData = {{ tasks_data|tojson }};
        
        if (tasksData && tasksData.length > 0) {
            if (window.calendarView) {
                window.calendarView.tasks = tasksData;
                window.calendarView.render();
            } else {
                if (typeof CalendarView !== 'undefined') {
                    window.calendarView = new CalendarView(tasksData);
                } else {
                    const container = document.getElementById('calendar-container');
                    if (container) {
                        container.innerHTML = '<p class="text-red-400 text-center py-8">Calendar view not available. Please refresh the page.</p>';
                    }
                }
            }
        } else {
            // Show message if no tasks
            const container = document.getElementById('calendar-container');
            if (container) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No tasks to display in calendar</p>';
            }
        }
    }


    // Initialize Sharing Manager (only if not already initialized)
    if (!window.sharingManager) {
        window.sharingManager = new SharingManager({{ project.id|tojson }}, {
            can_manage_collaborators: {{ user_permissions.can_manage_collaborators|lower|tojson }},
            can_manage_share_links: {{ user_permissions.can_manage_share_links|lower|tojson }},
            can_view_collaborators: {{ user_permissions.can_view_collaborators|lower|tojson }}
        });
    }
    
    // Initialize Activity Log Manager
    window.activityLogManager = new ActivityLogManager();
    
    // User info management with real-time active user tracking
    function updateUserInfo() {
        const projectId = document.querySelector('[data-project-id]').dataset.projectId;
        
        // Fetch active users from API
        fetch(`/api/projects/${projectId}/active-users`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Error fetching active users:', data.error);
                    return;
                }
                
                // Update active user count
                const activeUserCount = document.getElementById('active-user-count');
                if (activeUserCount) {
                    activeUserCount.textContent = data.count;
                }
                
                // Update active users display
                const activeUsersContainer = document.getElementById('active-users');
                if (activeUsersContainer) {
                    activeUsersContainer.innerHTML = '';
                    
                    data.active_users.forEach(user => {
                        const userElement = document.createElement('div');
                        userElement.className = 'active-user';
                        userElement.title = `${user.name}${user.is_current_user ? ' (You)' : ''} - Last active: ${new Date(user.last_activity).toLocaleTimeString()}`;
                        
                        // Get first letter of name for avatar
                        const firstLetter = user.name.charAt(0).toUpperCase();
                        
                        // Different colors for different users
                        const colors = ['bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-pink-500', 'bg-indigo-500'];
                        const colorIndex = user.id % colors.length;
                        const bgColor = user.is_current_user ? 'bg-blue-500' : colors[colorIndex];
                        
                        userElement.innerHTML = `
                            <div class="w-8 h-8 ${bgColor} rounded-full flex items-center justify-center text-white text-sm font-semibold">
                                ${firstLetter}
                            </div>
                        `;
                        
                        activeUsersContainer.appendChild(userElement);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching active users:', error);
                // Fallback to showing just current user
                const activeUserCount = document.getElementById('active-user-count');
                if (activeUserCount) {
                    activeUserCount.textContent = '1';
                }
            });
    }
    
    // Initialize user info on page load
    updateUserInfo();
    
    // Update every 30 seconds to refresh active user count
    setInterval(updateUserInfo, 30000);
    
    // Clean up active session when user leaves the page
    function cleanupActiveSession() {
        const projectId = document.querySelector('[data-project-id]').dataset.projectId;
        
        // Send cleanup request (fire and forget)
        fetch(`/api/projects/${projectId}/active-users`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: {{ current_user.id }}
            })
        }).catch(error => {
            console.log('Session cleanup failed (this is normal on page unload):', error);
        });
    }
    
    // Clean up session when page is unloaded
    window.addEventListener('beforeunload', cleanupActiveSession);
    window.addEventListener('pagehide', cleanupActiveSession);

    // Task Assignment Functionality
    let currentTaskId = null;
    let collaborators = [];

    // Load collaborators when page loads
    async function loadCollaborators() {
        try {
            const response = await fetch(`/api/projects/{{ project.id }}/collaborators`);
            const data = await response.json();
            if (data.collaborators) {
                collaborators = data.collaborators;
                populateAssignmentDropdown();
            }
        } catch (error) {
            console.error('Failed to load collaborators:', error);
        }
    }

    function populateAssignmentDropdown() {
        const select = document.getElementById('assignment-user-select');
        select.innerHTML = '<option value="">Unassigned</option>';
        
        collaborators.forEach(collaborator => {
            const option = document.createElement('option');
            option.value = collaborator.id;
            option.textContent = `${collaborator.name} (${collaborator.role})`;
            select.appendChild(option);
        });
    }

    // Task assignment modal handlers
    document.addEventListener('click', function(e) {
        if (e.target.closest('.assign-task')) {
            const button = e.target.closest('.assign-task');
            currentTaskId = button.dataset.taskId;
            const assignedTo = button.dataset.assignedTo;
            
            // Set current assignment
            const select = document.getElementById('assignment-user-select');
            select.value = assignedTo || '';
            
            // Show modal
            document.getElementById('task-assignment-modal').classList.remove('hidden');
        }
        
        if (e.target.closest('.unassign-task')) {
            const button = e.target.closest('.unassign-task');
            const taskId = button.dataset.taskId;
            
            // Confirm unassign action
            if (confirm('Are you sure you want to unassign this task?')) {
                unassignTask(taskId);
            }
        }
        
        if (e.target.id === 'close-assignment-modal' || e.target.id === 'cancel-assignment') {
            document.getElementById('task-assignment-modal').classList.add('hidden');
            currentTaskId = null;
        }
        
        if (e.target.id === 'save-assignment') {
            saveTaskAssignment();
        }
    });

    async function saveTaskAssignment() {
        if (!currentTaskId) return;
        
        const select = document.getElementById('assignment-user-select');
        const assignedToId = select.value;
        
        try {
            let response;
            if (assignedToId) {
                // Assign task
                response = await fetch(`/api/projects/{{ project.id }}/tasks/${currentTaskId}/assign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ assigned_to_id: parseInt(assignedToId) })
                });
            } else {
                // Unassign task
                response = await fetch(`/api/projects/{{ project.id }}/tasks/${currentTaskId}/unassign`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
            }
            
            const data = await response.json();
            
            if (response.ok) {
                // Update the UI
                updateTaskAssignmentUI(currentTaskId, assignedToId, data.assigned_to);
                
                // Close modal
                document.getElementById('task-assignment-modal').classList.add('hidden');
                currentTaskId = null;
                
                // Show success message
                if (assignedToId) {
                    showNotification(`Task assigned to ${data.assigned_to.name}`, 'success');
                } else {
                    showNotification('Task unassigned successfully', 'success');
                }
            } else {
                showNotification(data.error || 'Failed to assign task', 'error');
            }
        } catch (error) {
            console.error('Error assigning task:', error);
            showNotification('Failed to assign task', 'error');
        }
    }

    async function unassignTask(taskId) {
        try {
            const response = await fetch(`/api/projects/{{ project.id }}/tasks/${taskId}/unassign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Update the UI
                updateTaskAssignmentUI(taskId, null, null);
                showNotification('Task unassigned successfully', 'success');
            } else {
                showNotification(data.error || 'Failed to unassign task', 'error');
            }
        } catch (error) {
            console.error('Error unassigning task:', error);
            showNotification('Failed to unassign task', 'error');
        }
    }

    function updateTaskAssignmentUI(taskId, assignedToId, assignedToData) {
        const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
        if (!taskElement) return;
        
        // Find the assignment display area (now wrapped in a div)
        const assignmentContainer = taskElement.querySelector('.inline-flex.items-center.space-x-2');
        
        if (assignedToId && assignedToData) {
            if (assignmentContainer) {
                // Update existing assignment display
                assignmentContainer.innerHTML = `
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
                        <i class="fas fa-user mr-1"></i>
                        Assigned to: ${assignedToData.name}
                    </span>
                    <button class="unassign-task text-gray-500 hover:text-red-400 p-1 rounded-md hover:bg-red-500/10 transition-all duration-200"
                        data-task-id="${taskId}" 
                        title="Unassign Task">
                        <i class="fas fa-user-times text-xs"></i>
                    </button>
                `;
            } else {
                // Create new assignment display
                const taskInfo = taskElement.querySelector('.flex-1 .flex.items-center.space-x-4.mt-3.text-sm');
                if (taskInfo) {
                    const assignmentContainer = document.createElement('div');
                    assignmentContainer.className = 'inline-flex items-center space-x-2';
                    assignmentContainer.innerHTML = `
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-400">
                            <i class="fas fa-user mr-1"></i>
                            Assigned to: ${assignedToData.name}
                        </span>
                        <button class="unassign-task text-gray-500 hover:text-red-400 p-1 rounded-md hover:bg-red-500/10 transition-all duration-200"
                            data-task-id="${taskId}" 
                            title="Unassign Task">
                            <i class="fas fa-user-times text-xs"></i>
                        </button>
                    `;
                    taskInfo.appendChild(assignmentContainer);
                }
            }
        } else {
            // Remove assignment display
            if (assignmentContainer) {
                assignmentContainer.remove();
            }
        }
        
        // Update the assignment button data
        const assignButton = taskElement.querySelector('.assign-task');
        if (assignButton) {
            assignButton.dataset.assignedTo = assignedToId || '';
        }
    }

    function showNotification(message, type) {
        // Simple notification - you can enhance this with a proper notification system
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-xl text-white font-semibold z-50 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Load collaborators on page load
    loadCollaborators();

    // Task Flagging Functionality
    let currentFlagTaskId = null;

    // Flag/Discussion button click handlers (All users)
    document.addEventListener('click', function(e) {
        if (e.target.closest('.task-flag-btn')) {
            const button = e.target.closest('.task-flag-btn');
            const taskId = button.dataset.taskId;
            const flagStatus = button.dataset.flagStatus;
            
            currentFlagTaskId = taskId;
            
            if (flagStatus === 'not_flagged') {
                // Show flag comment modal for new flags
                showFlagCommentModal();
            } else {
                // Show unified flag/discussion modal
                showFlagDiscussionModal(taskId);
            }
        }
    });

    // Modal close handlers
    document.getElementById('close-flag-modal').addEventListener('click', hideFlagCommentModal);
    document.getElementById('close-flag-discussion-modal').addEventListener('click', hideFlagDiscussionModal);
    document.getElementById('cancel-flag').addEventListener('click', hideFlagCommentModal);
    document.getElementById('close-flag-discussion').addEventListener('click', hideFlagDiscussionModal);
    document.getElementById('submit-discussion-comment').addEventListener('click', submitDiscussionComment);

    // Submit flag handler
    document.getElementById('submit-flag').addEventListener('click', async function() {
        const comment = document.getElementById('flag-comment-text').value.trim();
        
        if (!comment) {
            showNotification('Please enter a comment explaining what needs clarification', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/projects/{{ project.id }}/tasks/${currentFlagTaskId}/flag`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ comment: comment })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                updateFlagUI(currentFlagTaskId, data.flag_status, data.flag_color);
                showNotification(data.message, 'success');
                hideFlagCommentModal();
            } else {
                showNotification(data.error || 'Failed to flag task', 'error');
            }
        } catch (error) {
            console.error('Error flagging task:', error);
            showNotification('Failed to flag task', 'error');
        }
    });

    // Resolve flag handler (only if user has permission)
    const resolveFlagBtn = document.getElementById('resolve-flag');
    if (resolveFlagBtn) {
        resolveFlagBtn.addEventListener('click', async function() {
        try {
            const response = await fetch(`/projects/{{ project.id }}/tasks/${currentFlagTaskId}/resolve-flag`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                updateFlagUI(currentFlagTaskId, data.flag_status, data.flag_color);
                showNotification(data.message, 'success');
                hideFlagDiscussionModal();
            } else {
                showNotification(data.error || 'Failed to resolve flag', 'error');
            }
        } catch (error) {
            console.error('Error resolving flag:', error);
            showNotification('Failed to resolve flag', 'error');
        }
        });
    }

    function showFlagCommentModal() {
        document.getElementById('flag-comment-modal').classList.remove('hidden');
        document.getElementById('flag-comment-text').value = '';
        document.getElementById('flag-comment-text').focus();
    }

    function hideFlagCommentModal() {
        document.getElementById('flag-comment-modal').classList.add('hidden');
        currentFlagTaskId = null;
    }

    function showFlagResolutionModal(taskId, isResolved = false) {
        // For now, we'll just show the modal. In a real implementation, 
        // you'd fetch the flag details from the server
        document.getElementById('flag-resolution-modal').classList.remove('hidden');
        
        if (isResolved) {
            document.getElementById('resolve-flag').textContent = 'Already Resolved';
            document.getElementById('resolve-flag').disabled = true;
        } else {
            document.getElementById('resolve-flag').textContent = 'Mark as Resolved';
            document.getElementById('resolve-flag').disabled = false;
        }
    }

    function hideFlagResolutionModal() {
        document.getElementById('flag-resolution-modal').classList.add('hidden');
        currentFlagTaskId = null;
    }

    async function showFlagDiscussionModal(taskId) {
        try {
            const response = await fetch(`/projects/{{ project.id }}/tasks/${taskId}/discussion`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Show/hide current flag section based on whether task is flagged
                const currentFlagSection = document.getElementById('current-flag-section');
                if (data.is_flagged && data.comment) {
                    currentFlagSection.style.display = 'block';
                    // Update title for active flag
                    currentFlagSection.querySelector('h4').textContent = 'Current Clarification Request:';
                    document.getElementById('flag-comment-display').textContent = data.comment;
                    document.getElementById('flagged-by-display').textContent = `Asked by ${data.flagged_by}`;
                    
                    // Format date
                    const flaggedDate = new Date(data.flagged_at);
                    document.getElementById('flagged-at-display').textContent = flaggedDate.toLocaleString();
                } else if (data.is_resolved && data.resolved_by && data.resolved_at) {
                    // Show resolved status in the discussion section
                    currentFlagSection.style.display = 'block';
                    currentFlagSection.querySelector('h4').textContent = 'Clarification History';
                    document.getElementById('flag-comment-display').textContent = 'Previously resolved';
                    document.getElementById('flagged-by-display').textContent = `Resolved by ${data.resolved_by}`;
                    
                    // Format date
                    const resolvedDate = new Date(data.resolved_at);
                    document.getElementById('flagged-at-display').textContent = resolvedDate.toLocaleString();
                } else {
                    currentFlagSection.style.display = 'none';
                }
                
                // Display discussion comments
                document.getElementById('discussion-thread').innerHTML = '';
                if (data.comments && data.comments.length > 0) {
                    data.comments.forEach(comment => {
                        addCommentToThread(comment);
                    });
                }
                
                // Show/hide resolve button based on permissions and flag status
                const resolveBtn = document.getElementById('resolve-flag');
                if (resolveBtn) {
                    resolveBtn.style.display = data.is_flagged ? 'block' : 'none';
                }
                
                document.getElementById('flag-discussion-modal').classList.remove('hidden');
            } else {
                showNotification(data.error || 'Failed to load discussion', 'error');
            }
        } catch (error) {
            console.error('Error loading discussion:', error);
            showNotification('Failed to load discussion', 'error');
        }
    }

    function hideFlagDiscussionModal() {
        document.getElementById('flag-discussion-modal').classList.add('hidden');
        // Clear discussion thread
        document.getElementById('discussion-thread').innerHTML = '';
        // Clear comment text
        document.getElementById('discussion-comment-text').value = '';
        currentFlagTaskId = null;
    }


    function addCommentToThread(comment) {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'p-3 bg-gray-800/30 rounded-lg border border-gray-700';
        commentDiv.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <div class="text-sm font-medium text-white">${comment.user_name}</div>
                <div class="text-xs text-gray-400">${new Date(comment.created_at).toLocaleString()}</div>
            </div>
            <div class="text-gray-300 text-sm whitespace-pre-wrap">${comment.comment}</div>
        `;
        document.getElementById('discussion-thread').appendChild(commentDiv);
    }

    function updateDiscussionButtonVisibility(taskId) {
        // Check if discussion button should be visible
        // This will be handled by the server-side template logic
        // For now, we'll just ensure the button is visible if there are comments
        const discussionBtn = document.querySelector(`[data-task-id="${taskId}"].task-discussion-btn`);
        if (discussionBtn) {
            // Button should remain visible since there are discussion comments
            discussionBtn.style.display = 'block';
        }
    }

    function updateFlagUI(taskId, flagStatus, flagColor) {
        const flagButton = document.querySelector(`[data-task-id="${taskId}"].task-flag-btn`);
        if (flagButton) {
            flagButton.dataset.flagStatus = flagStatus;
            
            // Update button styling based on flag status
            if (flagStatus === 'not_flagged') {
                flagButton.className = flagButton.className.replace(/bg-(orange|red|green)-600/, 'bg-orange-600');
                flagButton.className = flagButton.className.replace(/hover:bg-(orange|red|green)-700/, 'hover:bg-orange-700');
                flagButton.title = 'Flag for clarification';
                flagButton.innerHTML = '<i class="fas fa-flag mr-2"></i>Flag Task';
            } else if (flagStatus === 'flagged') {
                flagButton.className = flagButton.className.replace(/bg-(orange|red|green)-600/, 'bg-red-600');
                flagButton.className = flagButton.className.replace(/hover:bg-(orange|red|green)-700/, 'hover:bg-red-700');
                flagButton.title = 'Flagged for clarification';
                flagButton.innerHTML = '<i class="fas fa-flag mr-2"></i>Flagged';
            } else if (flagStatus === 'resolved') {
                flagButton.className = flagButton.className.replace(/bg-(orange|red|green)-600/, 'bg-green-600');
                flagButton.className = flagButton.className.replace(/hover:bg-(orange|red|green)-700/, 'hover:bg-green-700');
                flagButton.title = 'Flag resolved';
                flagButton.innerHTML = '<i class="fas fa-flag mr-2"></i>Flag Resolved';
            }
        }
        
        // Update main task section flag indicator
        const taskItem = document.querySelector(`[data-task-id="${taskId}"].task-item`);
        if (taskItem) {
            let flagIndicator = taskItem.querySelector('.flag-indicator');
            
            if (flagStatus === 'not_flagged') {
                // Remove flag indicator if it exists
                if (flagIndicator) {
                    flagIndicator.remove();
                }
            } else {
                // Create or update flag indicator
                if (!flagIndicator) {
                    flagIndicator = document.createElement('span');
                    flagIndicator.className = 'flag-indicator inline-flex items-center px-2 py-1 rounded-full text-xs font-medium';
                    flagIndicator.innerHTML = '<i class="fas fa-flag mr-1"></i>';
                    
                    // Insert after risk indicator or after task title
                    const riskIndicator = taskItem.querySelector('.risk-indicator');
                    const taskTitle = taskItem.querySelector('h3');
                    if (riskIndicator) {
                        riskIndicator.parentNode.insertBefore(flagIndicator, riskIndicator.nextSibling);
                    } else if (taskTitle) {
                        taskTitle.parentNode.insertBefore(flagIndicator, taskTitle.nextSibling);
                    }
                }
                
                // Update flag indicator styling and text
                if (flagStatus === 'flagged') {
                    flagIndicator.className = 'flag-indicator inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-500/20 text-red-400';
                    flagIndicator.innerHTML = '<i class="fas fa-flag mr-1"></i>Flagged';
                } else if (flagStatus === 'resolved') {
                    flagIndicator.className = 'flag-indicator inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-500/20 text-green-400';
                    flagIndicator.innerHTML = '<i class="fas fa-flag mr-1"></i>Flag Resolved';
                }
            }
        }
    }

    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.id === 'flag-comment-modal') {
            hideFlagCommentModal();
        }
        if (e.target.id === 'flag-discussion-modal') {
            hideFlagDiscussionModal();
        }
    });

    // Handle Enter key in flag comment textarea
    document.getElementById('flag-comment-text').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            document.getElementById('submit-flag').click();
        }
    });

    // Handle Enter key in discussion comment textarea
    document.getElementById('discussion-comment-text').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
            submitDiscussionComment();
        }
    });

    async function submitDiscussionComment() {
        const commentText = document.getElementById('discussion-comment-text').value.trim();
        
        if (!commentText) {
            showNotification('Please enter a comment', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/projects/{{ project.id }}/tasks/${currentFlagTaskId}/discussion/comment`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ comment: commentText })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Add comment to thread
                addCommentToThread(data.comment);
                // Clear textarea
                document.getElementById('discussion-comment-text').value = '';
                showNotification(data.message, 'success');
            } else {
                showNotification(data.error || 'Failed to add comment', 'error');
            }
        } catch (error) {
            console.error('Error adding comment:', error);
            showNotification('Failed to add comment', 'error');
        }
    }
</script>
{% endblock %}